{% load static %}

<c-layout title="Explore Movies | MovieDB">

  {{ block.extra_css }}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
      body {
          background-color: #212529;
          color: #f8f9fa;
      }
      nav.navbar {
          background-color: #2c2f33;
      }
      .navbar-brand {
          font-weight: bold;
          color: #f8f9fa !important;
      }
      .nav-link {
          color: #adb5bd !important;
      }
      .nav-link.active, .nav-link:hover {
          color: #ffffff !important;
      }
  </style>
  <style>
    .movie-card { background:#1e1e1e; border:none; border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,0.5); transition:.3s; }
    .movie-card:hover { transform:scale(1.05); }
    .movie-poster { width:100%; height:300px; object-fit:cover; border-radius:6px; }

    .shelf-row { display:flex; overflow-x:auto; gap:15px; padding-bottom:15px; }
    .shelf-item { flex:0 0 200px; }

    .shelf-title { color:#fff; border-left:5px solid #e50914; padding-left:15px; margin-bottom:15px; }
  </style>
  {{ endblock.extra_css }}

  <div class="container mb-5">
    <h1 class="text-center mb-4 text-warning">ðŸŽ¬ Explore New Releases</h1>

    {% if movies %}
      <c-featured_movie :movie="movies.0" />
    {% endif %}
  </div>

  <hr class="border-secondary" />

  <div class="container" id="dynamic-shelves-container"></div>

  {% for movie in movies %}
    <c-movie_modal :movie="movie" :user_review="user_reviews_dict|get_item:movie.id" />
  {% endfor %}

  {{ block.extra_js }}
  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
    }

    /* Update star icons based on rating (supports half-stars) */
    function renderStarsForContainer(container, rating) {
      const stars = container.querySelectorAll(".star");
      stars.forEach(star => {
          const val = parseInt(star.dataset.value, 10);
          // full star if rating >= val
          if (rating >= val) {
              star.classList.remove("fa-regular", "fa-star-half-stroke");
              star.classList.add("fa-solid", "fa-star", "filled");
          }
          // half star if rating >= val - 0.5
          else if (rating >= (val - 0.5)) {
              // Use half star icon
              star.classList.remove("fa-regular", "fa-star");
              star.classList.add("fa-solid", "fa-star-half-stroke", "filled");
          } else {
              // empty star
              star.classList.remove("fa-solid", "fa-star", "fa-star-half-stroke", "filled");
              star.classList.add("fa-regular", "fa-star");
          }
      });
    }

    /* Initialize star rating widgets for all containers */
    function initStarRatings() {
      document.querySelectorAll(".star-rating").forEach(container => {
          const stars = container.querySelectorAll(".star");
          const hiddenInput = container.parentElement.querySelector(".rating-input");

          // parse existing value (could be decimal string like "3.5")
          let currentRating = parseFloat(hiddenInput.value) || 0;

          // Initial render
          renderStarsForContainer(container, currentRating);

          // For mouse move and click detection, attach events to each star
          stars.forEach(star => {
              // Mouse move: show preview (half/full based on pointer position)
              star.addEventListener("mousemove", function (e) {
                  const rect = star.getBoundingClientRect();
                  const isLeftHalf = (e.clientX - rect.left) < (rect.width / 2);
                  const hoverRating = parseInt(star.dataset.value, 10) - (isLeftHalf ? 0.5 : 0);
                  renderStarsForContainer(container, hoverRating);
              });

              // Click: set rating
              star.addEventListener("click", function (e) {
                  const rect = star.getBoundingClientRect();
                  const isLeftHalf = (e.clientX - rect.left) < (rect.width / 2);
                  currentRating = parseInt(star.dataset.value, 10) - (isLeftHalf ? 0.5 : 0);
                  // write to hidden input (string)
                  hiddenInput.value = currentRating.toFixed(1);
                  renderStarsForContainer(container, currentRating);
              });

              // Accessibility: keyboard support for each star
              star.addEventListener("keydown", function (e) {
                  const val = parseInt(star.dataset.value, 10);
                  if (e.key === "Enter" || e.key === " ") {
                      currentRating = val;
                      hiddenInput.value = currentRating.toFixed(1);
                      renderStarsForContainer(container, currentRating);
                      e.preventDefault();
                  }
              });

              // Make stars focusable for keyboard
              star.setAttribute("tabindex", "0");
          });

          // When leaving the star container, restore selected rating
          container.addEventListener("mouseleave", function () {
              renderStarsForContainer(container, currentRating);
          });

          // Also update UI if hiddenInput value is changed programmatically
          // (not required now but good to keep)
          const observer = new MutationObserver(() => {
              currentRating = parseFloat(hiddenInput.value) || 0;
              renderStarsForContainer(container, currentRating);
          });
          observer.observe(hiddenInput, { attributes: true, attributeFilter: ['value'] });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const csrfToken = getCookie('csrftoken');

      // Initialize star UI widgets
      initStarRatings();

      /* --- Review Submission Logic --- */
      const forms = document.querySelectorAll(".review-form");
      forms.forEach(form => {
          form.addEventListener("submit", async (e) => {
              e.preventDefault();
              const movieId = form.dataset.movieId;
              const rating = form.querySelector("[name='rating']").value;
              const reviewText = form.querySelector("[name='review_text']").value;
              const messageDiv = form.parentElement.querySelector(".review-message");

              // Basic client-side validation
              if (!rating || parseFloat(rating) <= 0) {
                  messageDiv.textContent = "Please provide a rating (use the stars).";
                  messageDiv.style.color = "orange";
                  return;
              }

              try {
                  const response = await fetch(`/movies/api/movies/${movieId}/reviews/`, {
                      method: "POST",
                      headers: {
                          "Content-Type": "application/json",
                          "X-CSRFToken": csrfToken,
                      },
                      body: JSON.stringify({ rating, review_text: reviewText })
                  });

                  const data = await response.json();

                  if (response.ok) {
                      messageDiv.textContent = data.message || "Review submitted.";
                      messageDiv.style.color = "lightgreen";
                      // Slight delay so user sees the green message before reload
                      setTimeout(() => location.reload(), 900);
                  } else {
                      messageDiv.textContent = data.error || "An error occurred while submitting the review.";
                      messageDiv.style.color = "red";
                  }
              } catch (err) {
                  console.error(err);
                  messageDiv.textContent = "An unexpected error occurred.";
                  messageDiv.style.color = "red";
              }
          });
      });

      /* --- Dynamic Shelf Generation Logic (keeps your previous approach) --- */

      // Function to fetch data from an API endpoint
      async function fetchAPI(url) {
          try {
              const response = await fetch(url);
              if (!response.ok) throw new Error('Network response was not ok');
              return response.json();
          } catch (error) {
              console.error(`Error fetching data from ${url}:`, error);
              return [];
          }
      }

      // Simplified filtered movies fetch - currently hits the generic list API and expects JSON
      async function fetchFilteredMovies(filterType, filterValue) {
          // Uses movie list endpoint; adjust or replace with a proper filtered endpoint on backend
          return await fetchAPI("{% url 'api_movie_list_create' %}?limit=10");
      }

      function renderMovieItem(movie) {
          const posterUrl = movie.poster ? movie.poster : "{% static 'default_poster.jpg' %}";
          const title = movie.title || "Untitled";

          return `
              <div class="shelf-item">
                  <div class="card movie-card h-100" data-bs-toggle="modal" data-bs-target="#movieModal${movie.id}">
                      <img src="${posterUrl}" alt="${title}" class="movie-poster">
                      <div class="card-body p-2">
                          <h6 class="card-title text-light text-truncate" title="${title}">${title}</h6>
                      </div>
                  </div>
              </div>
          `;
      }

      async function renderShelf(title, endpoint, filterType) {
          const filters = await fetchAPI(endpoint);
          if (!Array.isArray(filters) || filters.length === 0) return;

          const randomFilter = filters[Math.floor(Math.random() * filters.length)];
          const filterName = randomFilter.name;
          const filterId = randomFilter.id;

          const movies = await fetchFilteredMovies(filterType, filterId);
          if (!Array.isArray(movies) || movies.length === 0) return;

          const shelfHTML = `
              <div class="shelf-container">
                  <h3 class="shelf-title">${title} (${filterName})</h3>
                  <div class="shelf-row">
                      ${movies.map(renderMovieItem).join('')}
                  </div>
              </div>
          `;
          const container = document.getElementById('dynamic-shelves-container');
          container.insertAdjacentHTML('beforeend', shelfHTML);
      }

      async function loadDynamicContent() {
          await renderShelf("Trending Tags", "{% url 'api_random_tags' %}", "tag_id");
          await renderShelf("Director Spotlight", "{% url 'api_random_directors' %}", "director_id");
          await renderShelf("Genre Mix", "{% url 'api_random_genres' %}", "genre_id");
      }

      loadDynamicContent();
    });
  </script>
  {{ endblock.extra_js }}

</c-layout>
