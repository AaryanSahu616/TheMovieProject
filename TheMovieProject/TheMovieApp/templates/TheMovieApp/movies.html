{% extends "TheMovieApp/base.html" %}
{% load static %}
{% load custom_tags %} 
{% load crispy_forms_tags %}

{% block title %}Explore Movies | MovieDB{% endblock %}

{% block extra_css %}
<style>
    /* Global Card Styles */
    .movie-card {
        background-color: #1e1e1e; /* Darker than body for contrast */
        border: none;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        transition: transform 0.3s ease-in-out;
        width: 100%;
        cursor: pointer;
    }
    .movie-card:hover { transform: scale(1.05); z-index: 10; }
    .movie-poster { width: 100%; height: 300px; object-fit: cover; border-radius: 6px; }
    .star { color: #f5c518; font-size: 1.2rem; }
    .text-truncate-2 { 
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Shelf/Carousel Styles */
    .shelf-container { padding: 20px 0; }
    .shelf-row { 
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto; /* Enable horizontal scrolling */
        -webkit-overflow-scrolling: touch;
        gap: 15px;
        padding-bottom: 15px;
    }
    .shelf-item { 
        flex: 0 0 200px; /* Set fixed width for each movie item */
        max-width: 200px;
        position: relative;
    }
    .shelf-title { color: #fff; margin-bottom: 15px; border-left: 5px solid #e50914; padding-left: 15px; }
    
    /* Scrollbar Styling (Optional: for aesthetics) */
    .shelf-row::-webkit-scrollbar { height: 8px; }
    .shelf-row::-webkit-scrollbar-thumb { background-color: #888; border-radius: 10px; }
    .shelf-row::-webkit-scrollbar-track { background: #333; }

    /* --- Modal Specific Styles --- */
    .modal-content { 
        background-color: #2c2f33; /* Dark background for modal */
        color: white; 
        border: 1px solid #444; /* Subtle border */
        border-radius: 10px; /* Slightly more rounded corners */
    }
    .modal-header {
        border-bottom: 1px solid #444; /* Darker border for separation */
        padding: 15px 20px;
    }
    .modal-title {
        color: #e50914; /* Netflix red for title */
        font-weight: bold;
    }
    .btn-close {
        filter: invert(1); /* Makes the default dark close icon white */
        opacity: 0.8;
        transition: opacity 0.2s ease-in-out;
    }
    .btn-close:hover {
        opacity: 1;
    }
    .modal-body {
        padding: 20px;
    }
    .modal-body p, .modal-body h6, .modal-body label {
        color: #ddd; /* Lighter grey for text for readability */
    }
    .modal-body strong {
        color: #fff; /* White for strong labels */
    }
    .modal-body hr {
        border-top: 1px solid #444; /* Separator color */
        margin: 20px 0;
    }
    /* Input/Select within modal */
    .form-control, .form-select { 
        background-color: #343a40; /* Darker input background */
        color: #fff; 
        border: 1px solid #555; /* Subtle border for inputs */
        border-radius: 5px;
        padding: 8px 12px;
    }
    .form-control:focus, .form-select:focus { 
        background-color: #3c3f44; 
        color: #fff; 
        border-color: #e50914; /* Highlight focus with accent color */
        box-shadow: 0 0 0 0.25rem rgba(229, 9, 20, 0.25); /* Glow effect */
    }
    .badge.bg-secondary {
        background-color: #4a4a4a !important; /* Slightly distinct badge color */
        color: #eee;
    }
    .btn-warning {
        background-color: #f5c518; /* IMDb yellow for the button */
        border-color: #f5c518;
        color: #1a1a1a; /* Dark text for contrast */
        font-weight: bold;
        transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
    }
    .btn-warning:hover {
        background-color: #e0b007; /* Slightly darker yellow on hover */
        border-color: #e0b007;
    }
    .review-message {
        margin-top: 10px;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="background-color: #141414; padding-top: 50px;">
    
    <div class="container mb-5">
        <h1 class="text-center mb-4 text-warning">ðŸŽ¬ Explore New Releases</h1>
        {% if movies|length > 0 %}
            {% with featured_movie=movies.0 %}
                <div class="p-5 rounded-3 shadow" style="background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('{% if featured_movie.poster %}{{ featured_movie.poster.url }}{% else %}{% static 'default_poster.jpg' %}{% endif %}'); background-size: cover; background-position: center;">
                    <h2 class="display-4 fw-bold text-white">{{ featured_movie.title }}</h2>
                    <p class="col-md-8 fs-5 text-light text-truncate-2">{{ featured_movie.synopsis|default:"No synopsis available." }}</p>
                    <button class="btn btn-danger btn-lg" type="button" data-bs-toggle="modal" data-bs-target="#movieModal{{ featured_movie.id }}">View Details & Review</button>
                </div>
            {% endwith %}
        {% endif %}
    </div>

    <hr style="border-top: 1px solid #333;">

    <div id="dynamic-shelves-container" class="container">
        </div>

    <div class="container shelf-container">
        <h3 class="shelf-title">All Movies List (A-Z)</h3>
        {% if movies %}
            <div class="row">
                {% for movie in movies %}
                    {# This uses the old grid display but adapted to the new card style #}
                    {% with user_review=user_reviews_dict|get_item:movie.id %}
                    <div class="col-6 col-md-3 col-lg-2 mb-4">
                        <div class="card movie-card h-100" data-bs-toggle="modal" data-bs-target="#movieModal{{ movie.id }}">
                            {% if movie.poster %}
                                <img src="{{ movie.poster.url }}" alt="{{ movie.title }}" class="movie-poster">
                            {% else %}
                                <img src="{% static 'default_poster.jpg' %}" alt="No poster" class="movie-poster">
                            {% endif %}
                            <div class="card-body p-2">
                                <h6 class="card-title text-light text-truncate">{{ movie.title }}</h6>
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                {% endfor %}
            </div>
        {% else %}
            <p class="text-center text-muted">No movies found in the database.</p>
        {% endif %}
    </div>

</div>

{% for movie in movies %}
    {% with user_review=user_reviews_dict|get_item:movie.id %}
        <div class="modal fade" id="movieModal{{ movie.id }}" tabindex="-1" aria-labelledby="movieModalLabel{{ movie.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title" id="movieModalLabel{{ movie.id }}">{{ movie.title }}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-5">
                                {% if movie.poster %}
                                    <img src="{{ movie.poster.url }}" class="img-fluid rounded mb-3" alt="{{ movie.title }}">
                                {% else %}
                                    <img src="{% static 'default_poster.jpg' %}" class="img-fluid rounded mb-3" alt="No poster">
                                {% endif %}
                                <p class="text-light small mt-2">
                                    {% for tag in movie.tags.all %}
                                        <span class="badge bg-secondary me-1">{{ tag.name }}</span>
                                    {% endfor %}
                                </p>
                            </div>
                            <div class="col-md-7">
                                
                                <p><strong>Director:</strong> {{ movie.director.name }}</p>
                                <p><strong>Release Date:</strong> {{ movie.release_date|date:"F j, Y" }}</p>
                                <p><strong>Synopsis:</strong> {{ movie.synopsis }}</p>
                                <p><strong>Genres:</strong> {% for g in movie.genre.all %}{{ g.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</p>

                                <hr>
                                <h6>{% if user_review %}Update Your Review{% else %}Add a Review{% endif %}</h6>

                                <form class="review-form" data-movie-id="{{ movie.id }}">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label for="rating{{ movie.id }}" class="form-label">Rating (1â€“5)</label>
                                        <select name="rating" id="rating{{ movie.id }}" class="form-select" required>
                                            {% for i in "12345" %}
                                                <option value="{{ forloop.counter }}" {% if user_review and user_review.rating == forloop.counter %}selected{% endif %}>{{ forloop.counter }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="review_text{{ movie.id }}" class="form-label">Your Review</label>
                                        <textarea name="review_text" id="review_text{{ movie.id }}" class="form-control" rows="3" required>{% if user_review %}{{ user_review.review_text }}{% endif %}</textarea>
                                    </div>
                                    <button type="submit" class="btn btn-warning">Submit Review</button>
                                </form>

                                <div class="mt-2 review-message text-light"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endwith %}
{% endfor %}
{% endblock %}

{% block extra_js %}
<script>
// Utility function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener("DOMContentLoaded", () => {
    const csrfToken = getCookie('csrftoken');
    const container = document.getElementById('dynamic-shelves-container');

    // --- 1. Review Submission Logic (Kept mostly the same) ---
    const forms = document.querySelectorAll(".review-form");
    forms.forEach(form => {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const movieId = form.dataset.movieId;
            const rating = form.querySelector("[name='rating']").value;
            const reviewText = form.querySelector("[name='review_text']").value;
            const messageDiv = form.parentElement.querySelector(".review-message");

            try {
                const response = await fetch(`/api/movies/${movieId}/reviews/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken,
                    },
                    body: JSON.stringify({ rating, review_text: reviewText })
                });

                const data = await response.json();

                if (response.ok) {
                    messageDiv.textContent = data.message;
                    messageDiv.style.color = "lightgreen";
                    setTimeout(() => location.reload(), 1000); 
                } else {
                    messageDiv.textContent = data.error || "An error occurred.";
                    messageDiv.style.color = "red";
                }

            } catch (err) {
                messageDiv.textContent = "An unexpected error occurred.";
                messageDiv.style.color = "red";
            }
        });
    });

    // --- 2. Dynamic Shelf Generation Logic ---
    
    // Function to fetch data from an API endpoint
    async function fetchAPI(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        } catch (error) {
            console.error(`Error fetching data from ${url}:`, error);
            return [];
        }
    }
    
    // Function to fetch movies based on filter (Need a MovieFilterAPI for this in your views.py)
    // NOTE: This assumes a new '/api/movies/filter/' endpoint that accepts type and id/name
    async function fetchFilteredMovies(filterType, filterValue) {
        // Since you don't have a generic filter API, let's simplify for demonstration.
        // In a real app, you'd call: `/api/movies/?${filterType}=${filterValue}`
        
        // TEMPORARY: Since we can't filter movies via an API endpoint yet, 
        // we'll fetch ALL movies and filter them client-side (inefficient for large data) 
        // or just use one of the existing APIs as a stand-in.
        
        // For a proper solution, you MUST implement a Movie list API with filtering:
        // class MovieFilterListAPIView(generics.ListAPIView):
        //     def get_queryset(self):
        //         queryset = Movie.objects.all()
        //         tag_id = self.request.query_params.get('tag_id')
        //         if tag_id:
        //             queryset = queryset.filter(tags__id=tag_id)
        //         ... (similarly for director_id, genre_id)
        //         return queryset.order_by('?')[:10]
        
        // For now, we will skip filtering and just display a static random list if the filter is ready.
        return await fetchAPI("{% url 'api_movie_list_create' %}?limit=10");
    }
    
    // Function to render a single movie item
    function renderMovieItem(movie) {
        const posterUrl = movie.poster ? movie.poster.replace('/media/', '/media/') : "{% static 'default_poster.jpg' %}";
        const title = movie.title;

        return `
            <div class="shelf-item">
                <div class="card movie-card h-100" data-bs-toggle="modal" data-bs-target="#movieModal${movie.id}">
                    <img src="${posterUrl}" alt="${title}" class="movie-poster">
                    <div class="card-body p-2">
                        <h6 class="card-title text-light text-truncate" title="${title}">${title}</h6>
                    </div>
                </div>
            </div>
        `;
    }

    // Function to render a dynamic shelf
    async function renderShelf(title, endpoint, filterType) {
        const filters = await fetchAPI(endpoint);
        
        if (filters.length === 0) return;

        // Choose a random filter from the list
        const randomFilter = filters[Math.floor(Math.random() * filters.length)];
        const filterName = randomFilter.name;
        const filterId = randomFilter.id;
        
        // Fetch movies based on the chosen filter (API endpoint required!)
        // As noted, this is currently simplified and requires a proper filtered API
        const movies = await fetchFilteredMovies(filterType, filterId);
        
        if (movies.length === 0) return;

        const shelfHTML = `
            <div class="shelf-container">
                <h3 class="shelf-title">${title} (${filterName})</h3>
                <div class="shelf-row">
                    ${movies.map(renderMovieItem).join('')}
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', shelfHTML);
    }
    
    // Load all the dynamic shelves
    async function loadDynamicContent() {
        await renderShelf("Trending Tags", "{% url 'api_random_tags' %}", "tag_id");
        await renderShelf("Director Spotlight", "{% url 'api_random_directors' %}", "director_id");
        await renderShelf("Genre Mix", "{% url 'api_random_genres' %}", "genre_id");
        
        // Optionally add a general 'New Releases' shelf here
    }

    loadDynamicContent();
});
</script>
{% endblock %}