{% extends "TheMovieApp/base.html" %}
{% load static %}
{% load custom_tags %}

{% block title %}Movies | MovieDB{% endblock %}

{% block extra_css %}
<style>
    .movie-card {
        background-color: #2c2f33;
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        transition: all 0.2s ease-in-out;
    }
    .movie-card:hover { transform: scale(1.02); }
    .movie-poster { width: 100%; height: 350px; object-fit: cover; border-top-left-radius: 12px; border-top-right-radius: 12px; }
    .star { color: #f5c518; font-size: 1.2rem; }
    .modal-content { background-color: #2c2f33; color: white; }
    .form-control, .form-select { background-color: #343a40; color: #fff; border: none; }
    .form-control:focus { background-color: #3c3f44; color: #fff; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-center mb-4">üé¨ All Movies</h1>

    {% if movies %}
        <div class="row">
            {% for movie in movies %}
                {% with user_review=user_reviews_dict|get_item:movie.id %}
                <div class="col-md-4 mb-4">
                    <div class="card movie-card h-100">
                        {% if movie.poster %}
                            <img src="{{ movie.poster.url }}" alt="{{ movie.title }}" class="movie-poster">
                            {% comment %} <img src="{{ movie.poster }}" alt="{{ movie.title }}" class="movie-poster"> {% endcomment %}
                        {% else %}
                            <img src="{% static 'default_poster.jpg' %}" alt="No poster" class="movie-poster">
                        {% endif %}

                        <div class="card-body">
                            <h5 class="card-title text-light">{{ movie.title }}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">
                                üé≠ {% for g in movie.genre.all %}{{ g.name }}{% if not forloop.last %}, {% endif %}{% empty %}No Genre{% endfor %}
                            </h6>
                            <p class="card-text text-light small mb-1">üë®‚Äçüíº Directed by: {{ movie.director.name }}</p>
                            <p class="card-text text-light small mb-3">üìÖ Released on: {{ movie.release_date|date:"F j, Y" }}</p>
                            {% if movie.Synopsis %}
                                <p class="card-text text-light small">{{ movie.Synopsis|truncatechars:100 }}</p>
                            {% endif %}

                            {% if user_review %}
                                <div class="mt-2">
                                    <strong>Your Rating:</strong>
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= user_review.rating %}
                                            <span class="star">‚òÖ</span>
                                        {% else %}
                                            <span class="star" style="opacity: 0.2;">‚òÖ</span>
                                        {% endif %}
                                    {% endfor %}
                                    <p class="mt-1 small text-light">{{ user_review.review_text }}</p>
                                </div>
                            {% endif %}

                            <div class="d-grid mt-3">
                                <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#movieModal{{ movie.id }}">
                                    {% if user_review %}Edit Your Review{% else %}Add Review{% endif %}
                                </button>
                            </div>
                        </div>
                    </div>9
                </div>

                <!-- Movie Modal -->
                <div class="modal fade" id="movieModal{{ movie.id }}" tabindex="-1" aria-labelledby="movieModalLabel{{ movie.id }}" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content">
                            <div class="modal-header border-secondary">
                                <h5 class="modal-title" id="movieModalLabel{{ movie.id }}">{{ movie.title }}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-5">
                                        {% if movie.poster %}
                                            <img src="{{ movie.poster.url }}" class="img-fluid rounded mb-3" alt="{{ movie.title }}">
                                        {% else %}
                                            <img src="{% static 'default_poster.jpg' %}" class="img-fluid rounded mb-3" alt="No poster">
                                        {% endif %}
                                    </div>
                                    <div class="col-md-7">
                                        <h6>üé≠ Genre:</h6>
                                        <p>{% for g in movie.genre.all %}<span class="badge bg-secondary">{{ g.name }}</span>{% empty %}No Genre{% endfor %}</p>
                                        <p><strong>Director:</strong> {{ movie.director.name }}</p>
                                        <p><strong>Release Date:</strong> {{ movie.release_date|date:"F j, Y" }}</p>
                                        <p><strong>Synopsis:</strong> {{ movie.Synopsis }}</p>

                                        <hr>
                                        <h6>{% if user_review %}Update Your Review{% else %}Add a Review{% endif %}</h6>

                                        <form class="review-form" data-movie-id="{{ movie.id }}">
                                            <div class="mb-3">
                                                <label for="rating{{ movie.id }}" class="form-label">Rating (1‚Äì5)</label>
                                                <select name="rating" id="rating{{ movie.id }}" class="form-select" required>
                                                    {% for i in "12345" %}
                                                        <option value="{{ forloop.counter }}" {% if user_review and user_review.rating == forloop.counter %}selected{% endif %}>{{ forloop.counter }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="review_text{{ movie.id }}" class="form-label">Your Review</label>
                                                <textarea name="review_text" id="review_text{{ movie.id }}" class="form-control" rows="3" required>{% if user_review %}{{ user_review.review_text }}{% endif %}</textarea>
                                            </div>
                                            <button type="submit" class="btn btn-warning">Submit Review</button>
                                        </form>

                                        <div class="mt-2 review-message text-light"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Modal -->
                {% endwith %}
            {% endfor %}
        </div>
    {% else %}
        <p class="text-center text-muted">No movies found in the database.</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const forms = document.querySelectorAll(".review-form");

    forms.forEach(form => {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const movieId = form.dataset.movieId;
            const rating = form.querySelector("[name='rating']").value;
            const reviewText = form.querySelector("[name='review_text']").value;
            const messageDiv = form.parentElement.querySelector(".review-message");

            try {
                const response = await fetch(`/api/movies/${movieId}/reviews/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                    body: JSON.stringify({ rating, review_text: reviewText })
                });

                const data = await response.json();

                if (response.ok) {
                    messageDiv.textContent = data.message;
                    messageDiv.style.color = "lightgreen";
                    setTimeout(() => location.reload(), 1000); // Refresh to update stars
                } else {
                    messageDiv.textContent = data.error || "An error occurred.";
                    messageDiv.style.color = "red";
                }

            } catch (err) {
                messageDiv.textContent = "An unexpected error occurred.";
                messageDiv.style.color = "red";
            }
        });
    });
});
</script>
{% endblock %}
